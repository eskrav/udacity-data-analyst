---
title: "Explore and Summarize Data (Prosper Loan Data)"
author: "Ekaterina Kravtchenko"
date: "7/1/2018"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
    css: styles.css
---

<script src="hideOutput.js"></script>

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(scales)
```

## Data Exploration

```{r data import, message=FALSE, warning=FALSE, cache=TRUE}
data <- read_csv("prosperLoanData.csv") %>% mutate_if(is.character, as.factor)
```

<!-- a. Headings and text should organize your thoughts and reflect your analysis as you explored the data. -->
<!-- b. Plots in this analysis do not need to be polished with labels, units, and titles; these plots are exploratory (quick and dirty). They should, however, be of the appropriate type and effectively convey the information you glean from them. -->
<!-- c. You can iterate on a plot in the same R chunk, but you donâ€™t need to show every plot iteration in your analysis. -->

### Data Cleaning

Above, I imported the character columns as factors, as having taken a closer look at the data, they are labels for categories, rather than strings (in the following analysis, I don't find any disconfirmation of this).  The first thing I will do now is take a closer look at the data, and see if other columns are formatted appropriately:

<div class="fold o">
```{r data glimpse, cache=TRUE, warning=FALSE, message=FALSE}
data[,1:7]
str(data)
```
</div>

The first thing I notice is that there are several date columns which should be formatted as such, and several boolean (True/False) type columns.  `ListingCategory.num` is actually a category label, not a numeric measure.  I also want to order the levels in some of the factor columns, as they are inherently ordered (`CreditGrade`, `ProsperRating.alpha`, `IncomeRange`, `LoanOriginationQuarter`).  Several of the columns have spaces or special characters in the column names, which makes it difficult to refer to these columns - I will rename these.

```{r basic data cleaning, cache=TRUE}
data %<>% 
  mutate_at(c("ListingCreationDate","ClosedDate","DateCreditPulled","FirstRecordedCreditLine","LoanOriginationDate"), as.Date) %>%
  mutate_at(c("IsBorrowerHomeowner","CurrentlyInGroup","IncomeVerifiable"), as.logical) %>%
  rename_all(~sub(" (numeric)", ".num", ., fixed=TRUE)) %>%
  rename_all(~sub(" (Alpha)", ".alpha", ., fixed=TRUE)) %>%
  rename_all(~sub(" (percentage)", ".per", ., fixed=TRUE)) %>%
  mutate_at("ListingCategory.num", as.factor)

data$CreditGrade <- ordered(data$CreditGrade, c("NC","HR","E","D","C","B","A","AA"))
data$ProsperRating.alpha <- ordered(data$ProsperRating.alpha, c("NC","HR","E","D","C","B","A","AA"))
data$IncomeRange <- ordered(data$IncomeRange, c("Not displayed","Not employed","$0","$1-24,999","$25,000-49,999","$50,000-74,999","$75,000-99,999","$100,000+"))
data$LoanOriginationQuarter <- ordered(data$LoanOriginationQuarter, c("Q1 2006", "Q2 2006", "Q3 2006", "Q4 2006", "Q1 2007", "Q2 2007", "Q3 2007", "Q4 2007", "Q1 2008", "Q2 2008", "Q3 2008", "Q4 2008", "Q1 2009", "Q2 2009", "Q3 2009", "Q4 2009", "Q1 2010", "Q2 2010", "Q3 2010", "Q4 2010", "Q1 2011", "Q2 2011", "Q3 2011", "Q4 2011", "Q1 2012", "Q2 2012", "Q3 2012", "Q4 2012", "Q1 2013", "Q2 2013", "Q3 2013", "Q4 2013", "Q1 2014", "Q2 2014", "Q3 2014", "Q4 2014"))
```

<div class="fold o">
```{r basic glimpse, cache=TRUE, message=FALSE, warning=FALSE}
str(data)
```
</div>

### First Impressions

Now I want to take a look at a summary of the data, to try to figure out what might be going on:

<div class="fold o">
```{r second data glimpse, cache=TRUE, message=FALSE, warning=FALSE}
summary(data)
```
</div>

I first see that there's a lot of missing data in many of the columns - it's not clear to me immediately whether this indicates that the data for those rows is truly missing (but theoretically could have been gathered), or if the information in those columns was simply not applicable to those rows.  I will sort this out as I move through the data, but I want to see if some information is, for example, only entered once the loan has been closed or completed.  First, though, I will identify the factors of interest.

#### Factors of Interest

Prosper Loans, through cursory research (https://en.wikipedia.org/wiki/Prosper_Marketplace), appears to be a peer-to-peer lending company.  The primary concern of companies is profit, and in this case, as I see no obvious measure of profit to the company itself, I will focus on profit to the lender (the lenders, presumably, keep the company in business).  Of course, borrowers likewise keep the company in business, and given the measures collected, it's possible to at least take a look at how borrower demographics influence loan funding.  Variable names are cross-referenced with a document linked from the Kaggle site: https://docs.google.com/spreadsheets/d/1gDyi_L4UvIrLTEC6Wri5nbaMmkGmLQBk-Yx3z0XDEtI/edit#gid=0.

The factors of most interest to lenders, I assume, might be (for example) `LoanStatus` (whether a loan is in good standing, repaid, or written off, etc.), `LenderYield` (yield minus servicing fee), `EstimatedEffectiveYield` (yield minus servicing fee and uncollected interest, and plus late fees) - likely more informative than the preceding, `EstimatedReturn` (overall estimated return, taking into account both estimated yield, and estimated loss), `EstimatedLoss` (loss on charge-offs), `LoanCurrentDaysDelinquent`, `LP_GrossPrincipalLoss`, and `LP_NetPrincipalLoss`.  These seem most indicative of how much lenders might profit, or lose, from any particular borrower.  What the lender should care most about, overall, is the ability to predict whether (or to what degree) a given (current or future) loan will pay off.  In some cases, it is unclear from the documentation whether these are predictions assigned by Prosper at the outset, or descriptions of what actually happened during the course of loans.  Exploring the data might shed some light on this.

On the other hand, the factors I intuitively expect might be predictive of profit are the following (for example): `CreditGrade` (credit assigned when the listing went live), `ProsperRating` (rating assigned when the loan went live), `ProsperScore` (risk score), `EstimatedReturn` (predicted difference between estimated effective yield and estimated loss), `ListingCategory` (what the loan is for), `Occupation`, `EmploymentStatus`, `EmploymentStatusDuration`, `IsBorrowerHomeowner`, `CreditScoreRangeLower`/`CreditScoreRangeUpper`, `FirstRecordedCreditLine`, `CurrentCreditLines`, `OpenCreditLines`, `TotalCreditLinespast7years`, `OpenRevolvingAccounts`, `OpenRevolvingMonthlyPayment`, `InquiriesLast6Months`, `TotalInquiries`, `CurrentDelinquencies`, `AmountDelinquent`, `DelinquenciesLast7Years`, `PublicRecordsLast10Years`, `PublicRecordsLast12Months`, `RevolvingCreditBalance`, `BankcardUtilization`, `AvailableBankcardCredit`, `TotalTrades` (number of trade lines ever opened), `TradesNeverDelinquent`, `TradesOpenedLast6Months`, `DebtToIncomeRatio`, `IncomeRange`, `IncomeVerifiable`, `StatedMonthlyIncome`, `TotalProsperLoans` (prior Prosper loans), `TotalProsperPaymentsBilled` (presumably, number of payments billed at time of listing), `OnTimeProsperPayments` (number of on-time payments at time of listing), `ProsperPaymentsLessThanOneMonthLate`, `ProsperPaymentsOneMonthPlusLate`, `ProsperPrincipalBorrowed` (amount borrowed at time of listing), `ProsperPrincipalOutstanding` (amount outstanding at time of listing), `Recommendations` (number of recommendations at time of listing), `InvestmentFromFriendsCount` (number of friends investing), and`InvestmentFromFriendsAmount` (amount invested by friends), and `Investors` (total number of investors).  There are too many of these categories, and I expect to narrow the list I will look at down to a few, particularly when multiple measures reflect more-or-less the same thing, or don't show any distinct patterns of correlating with other variables.

With respect to loan funding, some of the same predictors likely also influence loan amounts and borrower funding, as most likely reflected by `BorrowerAPR`, `BorrowerRate`, `LoanOriginalAmount`, `MonthlyLoanPayment`, `Term` (the length of the loan), and `PercentFunded` (although this is likely to not be informative for recently created loans).

The borrowers and loans are primary indexed through the variables `MemberKey` and `LoanNumber`.  Additional variables for keeping track of loans include `LoanOriginationDate` and `LoanOriginationQuarter`.  `ClosedDate` is useful for quickly indexing loans which have been closed, and for which firm conclusions can be drawn as to how much lenders profited.

#### NA Values

Here I want to double-check why information might be missing (e.g., whether some variables are assigned only once a loan has been closed).

<div class="fold o">
```{r loan completion, cache=TRUE}
closed <- round(colMeans(is.na(filter(data, !is.na(ClosedDate))))*100,2)
not_closed <- round(colMeans(is.na(filter(data, is.na(ClosedDate))))*100,2)
data.frame(closed, not_closed)
```
</div>

The first thing I notice is that whether a loan is closed, or not, is quite, but in most cases not entirely, predictive of whether missing values are present, or not.

None of the open loans have a credit grade, while about half of the closed loans do.  I assume that those which do are post-July 2009 loans, which were never assigned a credit grade.

<div class="fold o">
```{r closed credit grade, cache=TRUE, message=FALSE, warning=FALSE}
summary(filter(data, !is.na(ClosedDate) & is.na(CreditGrade)))
```
</div>

Here, I see that at least one loan prior to 2009 has no credit grade.

<div class="fold o">
```{r closed credit grade old, cache=TRUE, message=FALSE, warning=FALSE}
summary(filter(data, !is.na(ClosedDate) & is.na(CreditGrade) & ListingCreationDate < "2009-07-01"))
```
</div>

I see that 130 loans are missing a credit grade for no apparent reason.  I don't see any pattern here, and assume that it is impossible right now for me to tell why this data is missing.  However, this is a relatively small amount of data.

I am otherwise assuming that `CreditGrade` was effectively replaced by `ProsperScore` in 2009, and that these can be used more-or-less interchangeably, particularly given that their labels correspond.

Next, I notice that only about half of the closed loans have estimated effective lender yields or several other estimates of yield/loss, although they are not closed.  I assume these are pre-July 2009 listings, but I want to take a closer look at them.

<div class="fold o">
```{r lender yield NA, cache=TRUE, message=FALSE, warning=FALSE}
summary(filter(data, !is.na(ClosedDate) & is.na(EstimatedEffectiveYield)))
```
</div>

That is indeed the case, and as the same percentage of the other similar measures is missing, I will assume this is also the case for those measures.

I see that some borrower demographic, employment, and previous credit information is missing, but I assume that this is simply missing data, with no larger story behind it, particularly as this is a relatively small percentage of loans.  I also see that more of this information is missing for loans that have been closed, which suggests to me that this data was either lost, or not gathered as thoroughly in the past.

The majority of the borrowers in both categories have no prior Prosper history, and it would be interesting to see if, for example, not having any Prosper history leads to more delinquencies than having positive Prosper history.

Most loans were not charged off, but about 30% of closed loans at least at some point became delinquent (`LoanFirstDefaultedCycleNumber`).  A very small number of open loans are delinquent.

## Lender Profit

At this point, I want to take a look, through plotting correlations, at how predictive the above background, financial, or demographic measures are of measures most closely related to lender profit.

### `LoanStatus` vs. `CreditGrade`/`ProsperRating`

In the case of `LoanStatus`, as this is not a quantitative or clearly ordered factor, it may make sense to at least visually organize some of the levels.  I therefore 'group' all `Past Due` levels together, and order the levels loosely in terms of 'goodness' - assuming that being on time, or having paid off the loan, is 'good,' and that having defaulted, or having the loan charged off, is 'bad.'  I group `CreditGrade` and `ProsperRating` into one measure, and then plot `LoanStatus` by this new rating, to see if there are any obvious patterns on how likely one is to have a particular loan status, given a particular starting rating.

```{r first impressions, cache=TRUE}
pastDue <- levels(data$LoanStatus)[7:12]

plot_data <- data %>% 
  mutate(LoanStatus = fct_recode(LoanStatus, "PastDue" = pastDue[1], "PastDue" = pastDue[2], "PastDue" = pastDue[3], "PastDue" = pastDue[4], "PastDue" = pastDue[5], "PastDue" = pastDue[6])) %>%
  mutate(Rating = coalesce(CreditGrade, ProsperRating.alpha)) %>%
  mutate(LoanStatus = ordered(LoanStatus, c("Defaulted","Chargedoff","PastDue","Cancelled","Current","FinalPaymentInProgress","Completed"))) %>%
  group_by(Rating, LoanStatus) %>% 
  tally %>% 
  mutate(percent = n/sum(n))

ggplot(plot_data, aes(x = LoanStatus, y = percent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = percent(percent)), hjust = -0.25) +
  labs(title = "Loan Status by Rating", y = "Percent", x = "Loan Status") +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_discrete(labels = function(x) str_wrap(x, 10)) +
  facet_wrap(~Rating) +
  coord_flip()
```

What I see here is that the higher the rating, the greater the likelihood that the loan is either completed or current, and the less the likelihood that it is past due, charged off, or defaulted.  Overall, it seems that a customer with a higher rating at the time the loan is posted will indeed be more likely to pay off a loan in the future.

### Exploring Profit Measures

First, I want to get a sense of when these measures might be getting assigned, in cases where documentation does not make this clear.  To make this more clear, I will look at loans which have not been closed, and see if they systematically include this information (compared to loans which are closed).  If they do, it's relatively safe to say that these measures are predictions, rather than reports of actual yield.

<div class="fold o">
```{r profit measures, cache=TRUE, warning=FALSE, message=FALSE}
summary(filter(data, is.na(ClosedDate)))
```
</div>

All of these open loans have non-zero values assigned to the following measures, suggesting that these measures are predictive rather than descriptive of actual outcomes: `LenderYield`, `EstimatedEffectiveYield`, `EstimatedLoss`, `EstimatedReturn`.  On the other hand, many open loans have zero values assigned for these profit measures: `LP_CustomerPayments`, `LP_CustomerPrincipalPayments`, `LP_InterestandFees`, `LP_ServiceFees`, `LP_CollectionFees`, `LP_GrossPrincipalLoss`, `LP_NetPrincipalLoss`, and `LP_NonPrincipalRecoverypayments` (in fact, the last 3 have only zero values assigned).  These I will take a closer look at.

<div class="fold o">
```{r profit measures with zero, cache=TRUE, warning=FALSE, message=FALSE}
summary(filter(data, LP_CustomerPayments==0))
summary(filter(data, !is.na(ClosedDate) & LP_CustomerPayments==0))
summary(filter(data, !is.na(ClosedDate) & LP_CustomerPayments==0 & LoanStatus=="Completed"))

summary(filter(data, LoanStatus=="Completed" & LP_CustomerPayments==0))
```
</div>

The one thing I notice is that the majority of these loans originated in 2014.  Most, but not all, are still open.  Other `LP` values for most of them are 0.  Of those that are closed, most were either charged off, defaulted, or cancelled - only 10 were completed.  Of those that were completed, all are from the same loan origination quarter, have the same number of months since the loan originated, and are assigned loan numbers adjacent to each other.  All `LP` values are 0.

If the loan has been completed, then with the exception of those 10 records, all customers have made payments.

This leads me to strongly suspect that for this group of loans, the data is simply missing, perhaps through system error.  I therefore tentatively conclude that for this measure the value is 0 only for those borrowers whole loans are still open, or whole loans were charged off, defaulted, or cancelled.

<div class="fold o">
```{r profit measures with zero 2, cache=TRUE, warning=FALSE, message=FALSE}
summary(filter(data, LP_CollectionFees!=0))

summary(filter(data, LP_NetPrincipalLoss!=0))

summary(filter(data, LP_NonPrincipalRecoverypayments!=0))
summary(filter(data, !is.na(ClosedDate) & LP_NonPrincipalRecoverypayments==0))
summary(filter(data, !is.na(ClosedDate) & LP_NonPrincipalRecoverypayments==0 & LoanStatus=="Completed"))
```
</div>

What I see here is that `LP_CollectionFees` is non-0 primarily for people with poor credit grades or prosper ratings, and disproportionately for those whose loans have been charged off or defaulted.  All of them have apparently paid collection fees.

All records where `LP_NetPrincipalLoss` is 0 were either charged off, or defaulted.  Likewise, all records where `LP_NonPrincipalRecoverypayments` is 0 were charged off or defaulted.

All this leads me to provisionally conclude that the `LP-` records reflect actual, not predicted, measures of whether or to what extent a loan was repaid, and not predicted payments, and further that these measures accurately reflect **what they are meant to measure, for all customers**.

### Determining Relevant Measures

I am primarily interested at looking at how well predictors of lender or borrower profit (so to say) correlate with actual profit.  For this, I will exclude loans that are currently open, although it would for example be possible to look at how well various predictors correlate with likelihood of being current or past due.

The most relevant outcomes for lenders seem to be the following: `LoanStatus` (current of end status of the loan), `LP_CustomerPayments` (cumulative payments made by customers, prior to any charge-offs), `LoanOriginalAmount` (what the original loan was for, for determining percentage lost/repaid), and `LP_NetPrincipalLoss` (amount still uncollected after recoveries).  `LP_ServiceFees` and `LP_CollectionFees` are also relevant to determing final yield/loss, and can be added to `LP_NetPrincipalLoss` to approximate total loss.  Here I will create a new variable to consolidate the yield and loss measures I am interested in, so as to avoid unecessary and (for current purposes) uninteresting complexity in plotting outcomes.  I will also take a closer look at data where either yield seems relatively extreme.

<div class="fold o">
```{r new profit measure, warning=FALSE, message=FALSE, cache=TRUE}
relevant_data <- data %>%
  filter(LoanStatus %in% c("Cancelled","Chargedoff","Completed","Defaulted")) %>%
  mutate(PercentYield = ((LoanOriginalAmount-LP_NetPrincipalLoss+LP_ServiceFees+LP_CollectionFees+LP_NonPrincipalRecoverypayments+LP_InterestandFees)/LoanOriginalAmount)-1) %>%
  mutate(Completed = factor(ifelse(LoanStatus=="Completed","Completed","Not Completed")))

relevant_data[c(1,4,5),] %>% select(LoanOriginalAmount, starts_with("LP_"),PercentYield, Completed) %>% rowid_to_column() %>% gather(var, value, -rowid) %>% spread(rowid, value) %>% print(n = Inf)

summary(relevant_data)
```
</div>

Everything seems to check out with the `PercentYield` calculation.

<div class="fold o">
```{r profit measure extremes, warning=FALSE, message=FALSE, cache=TRUE}
summary(filter(relevant_data, PercentYield > 1))
summary(filter(relevant_data, PercentYield < -1))
```
</div>

For `PercentYield`, extreme gains seem to be cases of loans being defaulted or charged off, but fully, or almost fully recovered with large interest payments.

Extreme losses are due to loans that were charged off - where no payments were ever made or recovered, but investors lost money on collection fees.  Overall, this data appears sensible.

Now I want to take a closer look at the relationship between this measure, and the other primary measure of interest: loan status.

#### `LoanStatus` by `PercentYield`

```{r loan status by percent yield}
relevant_data %>% group_by(LoanStatus) %>% ggplot(aes(x = LoanStatus, y = PercentYield)) + geom_boxplot() + labs(title = "PercentYield by LoanStatus", y = "Percent Yield", x = "Loan Status") + scale_y_continuous(labels = percent)
```

Here it can be seen that cancelled loans do nor result in any money gained or lost by the lender, that lenders earn on average 20% on top of their initial investment for completed loans, and that thy lose about 50% of their original investment, on average, for charged off or defaulted loans, signifying that lenders may be taking a substantial risk, particularly with loans that are likely to be defaulted on or charged off.

Average `PercentYield` is roughly equal between loans that have been charged off, and those that defaulted, suggesting that the relevant measure here might be simply whether the loan was completed, or not (if one doesn't want to take into account the possibility that loans defaulted on will still be repaid at some point).

<div class="fold o">
```{r chargeoff vs default, cache=TRUE}
summary(filter(relevant_data, LoanStatus == "Chargedoff"))
summary(filter(relevant_data, LoanStatus == "Defaulted"))
```
</div>

There's no clear difference between loans charged off, and loans defaulted, aside from charged off loans being at least 121 days delinquent (defaulted loans may be any number of days delinquent).  Loans that were charged off tend to be created and closed slightly later.  For all purposes, however, it may make sense to treat these two categories as identical, for now.

### Predicted Profit

Now, before using them as predictors of actual profit, I want to briefly look at the relationship between measures of predicted profit: predicted loss, and predicted yield.  In this case, `EstimatedEffectiveYield` vs. `EstimatedLoss` seems to be the most informative comparison - how much one stands to gain, total, vs. how much one stands to lose.

#### `EstimatedEffectiveYield` vs. `EstimatedLoss`

```{r effective yield vs. estimated loss, cache=TRUE, warning=FALSE, message=FALSE}
ggplot(data, aes(x = EstimatedEffectiveYield, y = EstimatedLoss)) + 
  geom_hex(bins = 50) + 
  geom_smooth(formula = y~x)
```

This plot shows that, as one would expect, when the estimated effective yield (taking into account fees or possibly lost interest on charge-offs) is around or below zero, the estimated loss rises.  It also interestingly shows that as the estimated effective yield rises, so does the estimated loss.  Presumably based on historical data, then, Prosper predicts that the more one stands to gain, the more one stands to lose.  Lowest estimated risk of loss seems to be around 5% effective yield.

#### `EstimatedLoss` vs. `LenderYield`

```{r estimated loss vs. lender yield, cache=TRUE, warning=FALSE, message=FALSE}
ggplot(data, aes(x = EstimatedLoss, y = LenderYield)) + 
  geom_hex(bins = 50) + 
  geom_smooth(formula = y~x)
```

This graph shows clearly that while predicted lender yield increases with predicted loss, at higher levels of loss, the yield ceases to increase, and levels off, or even drops slightly towards higher levels of predicted loss.  This is presumably due to the fact that those loans which lenders profit the most from tend to be higher-interest loans - with those customers who are charged higher interest rates typically being those most likely to fail to repay their loan.

What one would expect, then, in terms of actual profit, is that as borrower demographics 'worsen' and interet rates rise, lenders are both more likely to lose, and to stand a chance of earning more.

### Scores vs. Actual Profit

#### `Rating`

##### `LoanStatus`

First, only 5 loans in the relevant data set were ever cancelled, so I will exclude this category from analysis.


<div class="fold o">
```{r need cancelled loans, cache=TRUE, warning=FALSE, message=FALSE}
relevant_data %>%
  filter(LoanStatus=="Cancelled")

relevant_data <- relevant_data %>%
  filter(LoanStatus!="Cancelled")
```
</div>


```{r loan status by rating, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(Rating = coalesce(CreditGrade, ProsperRating.alpha)) %>%
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(Rating, LoanStatus) %>% 
  tally %>% 
  mutate(percent = n/sum(n))

ggplot(plot_data, aes(x = LoanStatus, y=percent)) +
  geom_bar(stat = "identity") +
  labs(title = "Loan Status by Rating") +
  facet_wrap(~Rating) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##### `PercentYield`

```{r lender profit by rating, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(Rating = coalesce(CreditGrade, ProsperRating.alpha)) %>%
  group_by(Rating) %>%
  summarize(PercentYield = mean(PercentYield))

ggplot(plot_data, aes(x = Rating, y=PercentYield)) +
  geom_bar(stat = "identity")
```
<div class="fold o">
```{r rating NA, warning=FALSE, message=FALSE}
relevant_data %>% 
  mutate(Rating = coalesce(CreditGrade, ProsperRating.alpha)) %>%
  filter(is.na(Rating)) %>%
  summary()

relevant_data %>% 
  mutate(Rating = coalesce(CreditGrade, ProsperRating.alpha)) %>%
  filter(!is.na(Rating)) %>%
  summary()
```
</div>

It's not clear what distinguishes the `NA` Prosper ratings from others, whether this rating was assigned from the beginning, or why loans in this category are so profitable.  These loans were all created in 2009 and 2010, however.

#### `ProsperScore`

##### `LoanStatus`

```{r loan status by score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = ProsperScore)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  labs(title = "Loan Status by ProsperScore")
```

As can be seen, loans that were completed had the best risk score, although those that were charged off or defaulted are not markedly lower.

##### `PercentYield`

```{r lender profit by score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = factor(ProsperScore), y=PercentYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  labs(title = "Percent Yield by ProsperScore")
```

### Estimated Profit vs. Actual Profit

#### `EstimatedEffectiveYield`

##### `LoanStatus`

```{r loan status by estimated yield, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = EstimatedEffectiveYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  labs(title = "Loan Status by EstimatedEffectiveYield")
```

##### `PercentYield`

```{r lender profit by estimated yield, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = EstimatedEffectiveYield, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `EstimatedLoss`

##### `LoanStatus`

```{r loan status by estimated loss, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = EstimatedLoss)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  labs(title = "Loan Status by EstimatedLoss")
```

##### `PercentYield`

```{r lender profit by estimated loss, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = EstimatedLoss, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `EstimatedReturn`

##### `LoanStatus`

```{r loan status by estimated return, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = EstimatedReturn)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by estimated return, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = EstimatedReturn, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

### Demographics vs. Actual Profit

#### `Occupation`

##### `LoanStatus`

```{r loan status by occupation, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(LoanStatus, Occupation) %>% 
  tally() %>%
  spread(LoanStatus, n) %>%
  replace_na(list(Completed=0, Chargedoff=0, Defaulted=0)) %>%
  mutate(percent = Completed/(Completed+Chargedoff+Defaulted)) %>%
  mutate(Occupation = reorder(Occupation, percent))

ggplot(plot_data, aes(x = Occupation, y=percent)) +
  geom_bar(stat="identity") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##### `PercentYield`

```{r lender profit by occupation, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  group_by(Occupation) %>% 
  summarize(percent = mean(PercentYield, na.rm=TRUE)) %>%
  mutate(Occupation = reorder(Occupation, percent))

ggplot(plot_data, aes(x = Occupation, y=percent)) +
  geom_bar(stat="identity") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

There are too many occupations to make easy generalizations.  Occupations would likely need to be grouped into a smaller number of categories.  However, one can observe general trends - those with higher-paying occupations (or occupational prospects) seem to be more profitable customers.  On the other hand, students in general are among the bank's least profitable customers.  This suggests that income, which is grouped in a more sensible manner, may be useful to look at.

#### `IncomeRange`

##### `LoanStatus`

```{r loan status by income range, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(LoanStatus, IncomeRange) %>% 
  tally() %>%
  spread(LoanStatus, n) %>%
  replace_na(list(Completed=0, Chargedoff=0, Defaulted=0)) %>%
  mutate(PercentCompleted = Completed/(Completed+Chargedoff+Defaulted)) %>%
  mutate(IncomeRange = reorder(IncomeRange, PercentCompleted))

ggplot(plot_data, aes(x = IncomeRange, y=PercentCompleted)) +
  geom_bar(stat="identity") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##### `PercentYield`

```{r lender profit by income range, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = IncomeRange, y=PercentYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Here, it can be seen that as income rises, the `ProsperRating` increases, and other measures of profit decrease.  **As we have seen, `ProsperRating` correlates with credit score and likelihood of not defaulting**. This suggests that high-income lenders are lower-risk, but lower-income lenders, while being higher-risk, can also yield more profit.

#### `EmploymentStatus`

##### `LoanStatus`

```{r loan status by employment status, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(LoanStatus, EmploymentStatus) %>% 
  tally() %>%
  spread(LoanStatus, n) %>%
  replace_na(list(Completed=0, Chargedoff=0, Defaulted=0)) %>%
  mutate(PercentCompleted = Completed/(Completed+Chargedoff+Defaulted)) %>%
  mutate(EmploymentStatus = reorder(EmploymentStatus, PercentCompleted))

ggplot(plot_data, aes(x = EmploymentStatus, y=PercentCompleted)) +
  geom_bar(stat="identity") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

##### `PercentYield`

```{r lender profit by employment status, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = EmploymentStatus, y=PercentYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

What it looks like here is that Prosper ratings are highest for those employed, and employed full-time (it's not clear what the difference is), lower for those who are self-employed, retired, work part-time, or 'other,' and much lower for those not employed.  `LenderYield`, `EstimatedEffectiveYield`, and `EstimatedReturn`, however, are highest for those not employed, likely reflecting the higher anticipated interest charged to people in that group.  `Estimated Loss`, correspondingly, is also highest for those not employed - there's higher potential profit if the loans are paid back, but also significantly more risk.

#### `EmploymentStatusDuration`

##### `LoanStatus`

```{r loan status by employment status duration, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = EmploymentStatusDuration)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by employment status duration, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = EmploymentStatusDuration, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `IsBorrowerHomeowner`

##### `LoanStatus`

```{r loan status by home ownership, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(LoanStatus) %>%
  summarise(percent = mean(IsBorrowerHomeowner, na.rm=TRUE))

ggplot(plot_data, aes(x = LoanStatus, y = percent, cumulative = TRUE)) +
    geom_col()
```

##### `PercentYield`

```{r lender profit by home ownership, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = IsBorrowerHomeowner, y=PercentYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

#### `CreditScoreRangeLower`

##### `LoanStatus`

```{r loan status by lower credit score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = CreditScoreRangeLower)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by lower credit score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = CreditScoreRangeLower, y=PercentYield)) +
  geom_hex(bins = 25) +
  geom_smooth(formula = y~x)

plot_data <- relevant_data %>% filter(CreditScoreRangeLower>400)

ggplot(plot_data, aes(x = CreditScoreRangeLower, y=PercentYield)) +
  geom_hex(bins = 25) +
  geom_smooth(formula = y~x)
```

#### `CreditScoreRangeUpper`

##### `LoanStatus`

```{r loan status by upper credit score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = CreditScoreRangeUpper)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by upper credit score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = CreditScoreRangeUpper, y=PercentYield)) +
  geom_hex(bins = 25) +
  geom_smooth(formula = y~x)

plot_data <- relevant_data %>% filter(CreditScoreRangeUpper>400)

ggplot(plot_data, aes(x = CreditScoreRangeUpper, y=PercentYield)) +
  geom_hex(bins = 25) +
  geom_smooth(formula = y~x)
```

#### `FirstRecordedCreditLine`

##### `LoanStatus`

```{r loan status by first credit line, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = FirstRecordedCreditLine)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by first credit line, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = FirstRecordedCreditLine, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `OpenRevolvingAccounts`

##### `LoanStatus`

```{r loan status by open revolving accounts, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = OpenRevolvingAccounts)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by open revolving accounts, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = OpenRevolvingAccounts, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `InquiriesLast6Months`

##### `LoanStatus`

```{r loan status by inquiries, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = InquiriesLast6Months)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by inquiries, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = InquiriesLast6Months, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `AmountDelinquent`

##### `LoanStatus`

```{r loan status by amount delinquent, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = AmountDelinquent)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by amount delinquent, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = AmountDelinquent, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `DelinquenciesLast7Years`

##### `LoanStatus`

```{r loan status by delinquencies, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = DelinquenciesLast7Years)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by delinquencies, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = DelinquenciesLast7Years, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `RevolvingCreditBalance`

##### `LoanStatus`

```{r loan status by revolving balance, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = RevolvingCreditBalance)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by revolving balance, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = RevolvingCreditBalance, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `BankcardUtilization`

##### `LoanStatus`

```{r loan status by bankcard utilization, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = BankcardUtilization)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by bankcard utilization, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = BankcardUtilization, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `DebtToIncomeRatio`

##### `LoanStatus`

```{r loan status by debt ratio, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = DebtToIncomeRatio)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by debt ratio, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = DebtToIncomeRatio, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `IncomeVerifiable`

##### `LoanStatus`

```{r loan status by income varifiable, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(LoanStatus) %>%
  summarise(percent = mean(IncomeVerifiable, na.rm=TRUE))

ggplot(plot_data, aes(x = LoanStatus, y = percent, cumulative = TRUE)) +
    geom_col()
```

##### `PercentYield`

```{r lender profit by income verifiable, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = IncomeVerifiable, y=PercentYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

#### `TotalTrades`

##### `LoanStatus`

```{r loan status by total trades, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = TotalTrades)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by total trades, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = TotalTrades, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `TradesNeverDelinquent`

##### `LoanStatus`

```{r loan status by trade delinquency, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = TradesNeverDelinquent.per)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by trade delinquency, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = TradesNeverDelinquent.per, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

### Other Prosper Data vs. Actual Profit

#### `TotalProsperLoans`

##### `LoanStatus`

```{r loan status by prosper loans, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = TotalProsperLoans)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by prosper loans, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = factor(TotalProsperLoans), y=PercentYield)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

#### `OnTimeProsperPayments`

##### `LoanStatus`

```{r loan status by on time payments, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = OnTimeProsperPayments)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by on time payments, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = OnTimeProsperPayments, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `ProsperPrincipalOutstanding`

##### `LoanStatus`

```{r loan status by principal outstanding, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = ProsperPrincipalOutstanding)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by principal outstanding, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = ProsperPrincipalOutstanding, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `Recommendations`

##### `LoanStatus`

```{r loan status by recommendations, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = Recommendations)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by recommendations, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = Recommendations, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `InvestmentFromFriendsCount`

##### `LoanStatus`

```{r loan status by friend investment, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = InvestmentFromFriendsCount)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by friend investment, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = InvestmentFromFriendsCount, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `InvestmentFromFriendsAmount`

##### `LoanStatus`

```{r loan status by friend amount, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted")))

ggplot(plot_data, aes(x = LoanStatus, y = InvestmentFromFriendsAmount)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal)
```

##### `PercentYield`

```{r lender profit by friend amount, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data

ggplot(plot_data, aes(x = InvestmentFromFriendsAmount, y=PercentYield)) +
  geom_hex(bins = 50) +
  geom_smooth(formula = y~x)
```

#### `LoanOriginationQuarter`

<div class="fold o">
```{r}
summary(filter(relevant_data, is.na(LoanOriginationQuarter)))
relevant_data$LoanOriginationQuarter <- fct_explicit_na(relevant_data$LoanOriginationQuarter, "Q4 2005")
```
</div>

##### `LoanStatus`

```{r loan status by quarter, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(LoanStatus = ordered(LoanStatus, c("Completed","Chargedoff","Defaulted"))) %>%
  group_by(LoanOriginationQuarter, LoanStatus) %>%
  summarize(n=n()) %>%
  spread(LoanStatus,n) %>%
  replace_na(list(Completed=0, Chargedoff=0, Defaulted=0)) %>%
  summarize(percent = Completed/(Completed+Chargedoff+Defaulted))

ggplot(plot_data, aes(x = LoanOriginationQuarter, y = percent)) +
  geom_col() +
  stat_summary(fun.data = mean_cl_normal) +
  coord_flip()
```

##### `PercentYield`

```{r lender profit by quarter, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  group_by(LoanOriginationQuarter) %>% 
  summarize(PercentYield = mean(PercentYield, na.rm = TRUE))

ggplot(plot_data, aes(x = LoanOriginationQuarter, y=PercentYield)) +
  geom_bar(stat = "identity") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Ultimately, without knowing how the loans ultimately panned out, it is a bit difficult to use this data to make future predictions.

## Borrower Profit

Here, I will look at `BorrowerAPR` (lower is better), `BorrowerRate` (lower is better), `LoanOriginalAmount` (very roughly assuming that getting larger loans is somewhat preferable, though this is likely confounded by the borrower's needs and financial situation), `MonthlyLoanPayment` (lower is better), `Term` (roughly assuming that longer is better), and `PercentFunded` (more is better).

```{r borrower relevant data, cache=TRUE}
relevant_data <- data %>%
  mutate(PercentYield = ((LoanOriginalAmount-LP_NetPrincipalLoss+LP_ServiceFees+LP_CollectionFees+LP_NonPrincipalRecoverypayments+LP_InterestandFees)/LoanOriginalAmount)-1)
```


### Scores vs. Actual Profit

#### `Rating`

```{r borrower profit by rating, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  mutate(Rating = coalesce(CreditGrade, ProsperRating.alpha)) %>%
  select(Rating,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -Rating)

ggplot(plot_data, aes(x = Rating, y=value)) +
  geom_col() + 
  facet_grid(Measure ~ ., scales="free")
```

#### `ProsperScore`

```{r borrower profit by sore, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(ProsperScore,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -ProsperScore)

ggplot(plot_data, aes(x = factor(ProsperScore), y=value)) +
  geom_col() + 
  facet_grid(Measure ~ ., scales="free")
```

### Estimated Profit vs. Actual Profit

#### `EstimatedEffectiveYield`

```{r borrower profit by estimated yield, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(EstimatedEffectiveYield,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -EstimatedEffectiveYield)

ggplot(plot_data, aes(x = EstimatedEffectiveYield, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `EstimatedLoss`

```{r borrower profit by estimated loss, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(EstimatedLoss,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -EstimatedLoss)

ggplot(plot_data, aes(x = EstimatedLoss, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `EstimatedReturn`

```{r borrower profit by estimated return, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(EstimatedReturn,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -EstimatedReturn)

ggplot(plot_data, aes(x = EstimatedReturn, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

### Demographics vs. Actual Profit

#### `Occupation`

```{r borrower profit by occupation, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  select(Occupation,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  # mutate(Occupation = reorder(Occupation, BorrowerRate)) %>%
  gather(Measure, value, -Occupation)

ggplot(plot_data, aes(x = Occupation, y=value)) +
  geom_col() +
  facet_grid(Measure ~ ., scales="free")
```

There are too many occupations to make easy generalizations.  Occupations would likely need to be grouped into a smaller number of categories.  However, one can observe general trends - those with higher-paying occupations (or occupational prospects) seem to be more profitable customers.  On the other hand, students in general are among the bank's least profitable customers.  This suggests that income, which is grouped in a more sensible manner, may be useful to look at.

#### `IncomeRange`

```{r borrower profit by income range, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(IncomeRange,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -IncomeRange)

ggplot(plot_data, aes(x = IncomeRange, y=value)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_grid(Measure ~ ., scales="free")
```

Here, it can be seen that as income rises, the `ProsperRating` increases, and other measures of profit decrease.  **As we have seen, `ProsperRating` correlates with credit score and likelihood of not defaulting**. This suggests that high-income lenders are lower-risk, but lower-income lenders, while being higher-risk, can also yield more profit.

#### `EmploymentStatus`

```{r borrower profit by employment status, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(EmploymentStatus,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -EmploymentStatus)

ggplot(plot_data, aes(x = EmploymentStatus, y=value)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_grid(Measure ~ ., scales="free")
```

What it looks like here is that Prosper ratings are highest for those employed, and employed full-time (it's not clear what the difference is), lower for those who are self-employed, retired, work part-time, or 'other,' and much lower for those not employed.  `LenderYield`, `EstimatedEffectiveYield`, and `EstimatedReturn`, however, are highest for those not employed, likely reflecting the higher anticipated interest charged to people in that group.  `Estimated Loss`, correspondingly, is also highest for those not employed - there's higher potential profit if the loans are paid back, but also significantly more risk.

#### `EmploymentStatusDuration`

```{r borrower profit by employment duration, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(EmploymentStatusDuration,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -EmploymentStatusDuration)

ggplot(plot_data, aes(x = EmploymentStatusDuration, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `IsBorrowerHomeowner`

```{r borrower profit by home ownership, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(IsBorrowerHomeowner,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -IsBorrowerHomeowner)

ggplot(plot_data, aes(x = IsBorrowerHomeowner, y=value)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  facet_grid(Measure ~ ., scales="free")
```

#### `CreditScoreRangeLower`

```{r borrower profit by lower credit score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(CreditScoreRangeLower,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -CreditScoreRangeLower)

ggplot(plot_data, aes(x = CreditScoreRangeLower, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `CreditScoreRangeUpper`

```{r borrower profit by upper credit score, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(CreditScoreRangeUpper,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -CreditScoreRangeUpper)

ggplot(plot_data, aes(x = CreditScoreRangeUpper, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `FirstRecordedCreditLine`

```{r borrower profit by first credit line, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(FirstRecordedCreditLine,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -FirstRecordedCreditLine)

ggplot(plot_data, aes(x = FirstRecordedCreditLine, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `OpenRevolvingAccounts`

```{r borrower profit by open revolving accounts, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(OpenRevolvingAccounts,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -OpenRevolvingAccounts)

ggplot(plot_data, aes(x = OpenRevolvingAccounts, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `InquiriesLast6Months`

```{r borrower profit by inquiries, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(InquiriesLast6Months,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -InquiriesLast6Months)

ggplot(plot_data, aes(x = InquiriesLast6Months, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `AmountDelinquent`

```{r borrower profit by amount delinquent, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(AmountDelinquent,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -AmountDelinquent)

ggplot(plot_data, aes(x = AmountDelinquent, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `DelinquenciesLast7Years`

```{r borrower profit by delinquencies, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(DelinquenciesLast7Years,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -DelinquenciesLast7Years)

ggplot(plot_data, aes(x = DelinquenciesLast7Years, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `RevolvingCreditBalance`

```{r borrower profit by revolving balance, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(RevolvingCreditBalance,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -RevolvingCreditBalance)

ggplot(plot_data, aes(x = RevolvingCreditBalance, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `BankcardUtilization`

```{r borrower profit by bankcard utilization, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(BankcardUtilization,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -BankcardUtilization)

ggplot(plot_data, aes(x = BankcardUtilization, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `DebtToIncomeRatio`

```{r borrower profit by debt ratio, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(DebtToIncomeRatio,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -DebtToIncomeRatio)

ggplot(plot_data, aes(x = DebtToIncomeRatio, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `IncomeVerifiable`

```{r borrower profit by income verifiable, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(IncomeVerifiable,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -IncomeVerifiable)

ggplot(plot_data, aes(x = IncomeVerifiable, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `TotalTrades`

```{r borrower profit by total trades, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(TotalTrades,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -TotalTrades)

ggplot(plot_data, aes(x = TotalTrades, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `TradesNeverDelinquent`

```{r borrower profit by trade delinquency, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(TradesNeverDelinquent.per,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -TradesNeverDelinquent.per)

ggplot(plot_data, aes(x = TradesNeverDelinquent.per, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

### Other Prosper Data vs. Actual Profit

#### `TotalProsperLoans`

```{r borrower profit by prosper loans, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(TotalProsperLoans,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -TotalProsperLoans)

ggplot(plot_data, aes(x = factor(TotalProsperLoans), y=value)) +
  geom_boxplot() +
  stat_summary(fun.data = mean_cl_normal) + 
  facet_grid(Measure ~ ., scales="free")
```

#### `OnTimeProsperPayments`

```{r borrower profit by prosper payments, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(OnTimeProsperPayments,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -OnTimeProsperPayments)

ggplot(plot_data, aes(x = OnTimeProsperPayments, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `ProsperPrincipalOutstanding`

```{r borrower profit by principal outstanding, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(ProsperPrincipalOutstanding,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -ProsperPrincipalOutstanding)

ggplot(plot_data, aes(x = ProsperPrincipalOutstanding, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `Recommendations`

```{r borrower profit by recommendations, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(Recommendations,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -Recommendations)

ggplot(plot_data, aes(x = Recommendations, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `InvestmentFromFriendsCount`

```{r borrower profit by friend investment, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(InvestmentFromFriendsCount,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -InvestmentFromFriendsCount)

ggplot(plot_data, aes(x = InvestmentFromFriendsCount, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `InvestmentFromFriendsAmount`

```{r borrower profit by friend amount, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>%
  select(InvestmentFromFriendsAmount,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -InvestmentFromFriendsAmount)

ggplot(plot_data, aes(x = InvestmentFromFriendsAmount, y=value)) +
  stat_binhex() +
  geom_smooth(formula = y~x) + 
  facet_wrap(~Measure, scales="free")
```

#### `LoanOriginationQuarter`

```{r borrower profit by loan quarter, cache=TRUE, warning=FALSE, message=FALSE}
plot_data <- relevant_data %>% 
  select(LoanOriginationQuarter,BorrowerAPR,BorrowerRate,LoanOriginalAmount,MonthlyLoanPayment,Term,PercentFunded) %>%
  gather(Measure, value, -LoanOriginationQuarter)

ggplot(plot_data, aes(x = LoanOriginationQuarter, y=value)) +
  geom_col(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  facet_grid(Measure ~ ., scales="free")
```


## Final Plots and Summary

What is notable above is that in each graph where there is a noticeable relationship between profit predictors and profit measures, the Prosper rating is inversely correlated with the profit measures.  What is also notable is that there is a consistent relationship between lender yield, and lender loss: the more the lender stands to gain, the more they stand to lose.  I look at this in more detail below.  What is also notable is that estimated effective yield is **always** a bit less than both the estimated yield, reflecting also the estimated loss.

Assuming that the various profit measures, which may reflect only profit for clients/lenders, rather than for the company itself, are in fact what we want to be looking at, it is possible to notice certain trends which may be worth looking at more closely.

Further, assuming that lenders also care about potential missed payments, particularly if this would put them in a financial bind, it is worth looking at strong demographic predictors of delinquency, which does not appear to be reflected in the Prosper rating.

<!-- You will select three plots from your analysis to polish and share in this section. The three plots should show different trends and should be polished with appropriate labels, units, and titles (see the Project Rubric for more information). -->

### Lender yield by estimated loss

```{r final plot 1, cache=TRUE}

```

### Lender profit by number of open revolving accounts

```{r final plot 2, cache=TRUE}

```

### Lender profit by loan origination quarter

```{r final plot 3, cache=TRUE}

```

## Reflection

<!-- This should contain a few sentences about your struggles, successes, and ideas for future exploration on the data set (see the Project Rubric for more information). -->

First, I encountered a fair bit of trouble interpreting the data without any background story.  Googling around for info on Prosper loans online, I was able to get a general idea of what the company was doing, which made interpreting the data somewhat easier.

At this point, it is still difficult to say much about this data without knowing, in a lot more detail: what realities the less obvious measures reflect; the story behind the data; how certain measures are gathered and determined; and how the various measures reflect on both profit for the company, and profit for the clients.  What would be needed is to take a much closer and more in-depth look at what the company does, what purpose the data serves, and how the measures were collected and what they reflect.