---
title: "Explore and Summarize Data (Prosper Loan Data)"
author: "Ekaterina Kravtchenko"
date: "5/20/2018"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Exploration

```{r data import, message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)
library(scales)
data <- read_csv("prosperLoanData.csv") %>% mutate_if(is.character, as.factor)
```

a. Headings and text should organize your thoughts and reflect your analysis as you explored the data.
b. Plots in this analysis do not need to be polished with labels, units, and titles; these plots are exploratory (quick and dirty). They should, however, be of the appropriate type and effectively convey the information you glean from them.
c. You can iterate on a plot in the same R chunk, but you donâ€™t need to show every plot iteration in your analysis.

### Data Cleaning

Above, I by default imported the character columns as factors, as (....).  The first thing I will do now is take a closer look at the data, and see if other columns are formatted appropriately:

```{r data glimpse, cache=TRUE}
data
str(data)
```

The first thing I notice is that there are several date columns which should be formatted as such, and several boolean (True/False) columns.  I also want to order the levels in some of the factor columns, as they are inherently ordered (`CreditGrade`, `ProsperRating.alpha`, `IncomeRange`, `LoanOriginationQuarter`).

```{r basic data cleaning, cache=TRUE}
data %<>% 
  mutate_at(c("ListingCreationDate","ClosedDate","DateCreditPulled","FirstRecordedCreditLine","LoanOriginationDate"), as.Date) %>%
  mutate_at(c("IsBorrowerHomeowner","CurrentlyInGroup","IncomeVerifiable"), as.logical) %>%
  rename_all(~sub(" (numeric)", ".num", ., fixed=TRUE)) %>%
  rename_all(~sub(" (Alpha)", ".alpha", ., fixed=TRUE)) %>%
  rename_all(~sub(" (percentage)", ".per", ., fixed=TRUE))

data$CreditGrade <- ordered(data$CreditGrade, c("NC","HR","E","D","C","B","A","AA"))
data$ProsperRating.alpha <- ordered(data$ProsperRating.alpha, c("NC","HR","E","D","C","B","A","AA"))
data$IncomeRange <- ordered(data$IncomeRange, c("Not displayed","Not employed","$0","$1-24,999","$25,000-49,999","$50,000-74,999","$75,000-99,999","$100,000+"))
data$LoanOriginationQuarter <- ordered(data$LoanOriginationQuarter, c("Q1 2006", "Q2 2006", "Q3 2006", "Q4 2006", "Q1 2007", "Q2 2007", "Q3 2007", "Q4 2007", "Q1 2008", "Q2 2008", "Q3 2008", "Q4 2008", "Q1 2009", "Q2 2009", "Q3 2009", "Q4 2009", "Q1 2010", "Q2 2010", "Q3 2010", "Q4 2010", "Q1 2011", "Q2 2011", "Q3 2011", "Q4 2011", "Q1 2012", "Q2 2012", "Q3 2012", "Q4 2012", "Q1 2013", "Q2 2013", "Q3 2013", "Q4 2013", "Q1 2014", "Q2 2014", "Q3 2014", "Q4 2014"))

str(data)
```

### First Impressions

Now I want to take a look at a summary of the data, to try to figure out what might be going on:

```{r second data glimpse, cache=TRUE}
summary(data)
glimpse(data)
```

I first see that there's a lot of missing data in many of the columns - it's not clear to me immediately whether this indicates that the data for those rows is truly missing (but theoretically could have been gathered), or if the information in those columns was simply not applicable to those rows.  I will sort this out as I move through the data.

The factors of most interest to a bank, I assume, might be (for example) `LoanStatus`, `LenderYield`, `EstimatedEffectiveYield`, `EstimatedLoss`, `EstimatedReturn`, `CurrentDelinquencies`, `AmountDelinquent`, `OnTimeProsperPayments`, `LoanCurrentDaysDelinquent`, `LP_GrossPrincipalLoss`, and `LP_NetPrincipalLoss`.  Since the primary concern of a business is profit, these seem most indicative of how much the bank might profit from any particular customer.  What the bank should care about, overall, is the ability to predict whether (or to what degree) a given (current or future) customer will be profitable.

On the other hand, the factors I intuitively expect might be predictive of profit are the following (for example): `CreditGrade`, `Occupation`, `EmploymentStatus`, `EmploymentStatusDuration`, `IsBorrowerHomeowner`, `FirstRecordedCreditLine`, `OpenRevolvingAccounts`, `InquiriesLast6Months`, `RevolvingCreditBalance`, `BankcardUtilization`, `TotalTrades`, `DebtToIncomeRatio`, `IncomeRange`, `IncomeVerifiable`, `TotalProsperLoans`,  and `LoanOriginationQuarter`.

## Predictive Value

At this point, I want to take a look at how predictive the above background or demographic factors are of factors most closely related to profit.  First, I will plot this.

### Loan Status vs. Credit Grade

For `LoanStatus`, as this is not a quantitative or clearly ordered factor, it may make sense to group some of the levels.  I therefore group all `Past Due` levels together, and order the levels loosely in terms of 'goodness' - assuming that being on time, or having paid off the loan, is 'good,' and that having defaulted, or having the loan charged off, is 'bad.'  I then plot `LoanStatus` by `CreditGrade`, to see if there are any obvious patterns on how likely one is to have a particular loan status, given a particular credit grade.

```{r first impressions, echo=FALSE}
pastDue <- levels(data$LoanStatus)[7:12]

plot_data <- data %>% 
  mutate(LoanStatus = fct_recode(LoanStatus, "PastDue" = pastDue[1], "PastDue" = pastDue[2], "PastDue" = pastDue[3], "PastDue" = pastDue[4], "PastDue" = pastDue[5], "PastDue" = pastDue[6])) %>%
  mutate(LoanStatus = ordered(LoanStatus, c("Defaulted","Chargedoff","PastDue","Cancelled","Current","FinalPaymentInProgress","Completed"))) %>%
  group_by(CreditGrade, LoanStatus) %>% 
  tally %>% 
  mutate(percent = n/sum(n))

ggplot(plot_data, aes(x = LoanStatus, y = percent)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = percent(percent)), hjust = -0.25) +
  labs(title = "Loan Status by Credit Grade", y = "Percent", x = "Loan Status") +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_discrete(labels = function(x) str_wrap(x, 10)) +
  facet_wrap(~CreditGrade) +
  coord_flip()
```

What I see here is that the higher the credit score, in general, the greater the likelihood that the loan has been paid off, and the lower the likelihood that it has been charged off or defaulted.  Things get a bit more complicated with the `NA` category - these customers are all over the place, and while most are current, and a sizeable number have paid off their loans, there are also a number of customers who are past due, have defaulted, or have had their loan charged off.  This overall picture suggests to me that the bank assigns credit grades only after a loan has been paid off, or otherwise 'ended.' There is no way to predict based on credit grades, for existing customers in this database, whether a particular loan will be paid off (or otherwise), but it is likely that a customer with a higher credit grade will be more likely to pay off a loan in the future.

At this point, I want to take a closer look at the `NA` catetory.

```{r NA credit grades}
data %>%
  group_by(CreditGrade) %>%
  summarize_if(is.numeric, mean, na.rm=TRUE)
```

It is not immediately clear what distinguishes these lenders, and why they have no recorded credit rating.  The `NA`s have much higher `ListingNumber`s, a slightly higher `Term`, they actually have the following: `EstimatedEffectiveYield`, `EstimatedLoss`, `EstimatedReturn`, `ProsperRating`, `ProsperScore`.  They have a higher `ListingCategory`, a much higher average `EmploymentStatusDuration`, but don't differ too obviously along other measures.  They have lower average `PublicRecordsLast12Months`, significantly more `TotalProsperPaymentsBilled` and `OnTimeProsperPayments`, and a much lower average `LoanCurrentDaysDelinquent`.  They have a lower `LoanMonthsSinceOrigination` and a higher `LoanNumber`.  They are the only ones less than fully funded (`PercentFunded`).  They have relatively little investment from friends (`InvestmentFromFriendsAmount`).  

```{r credit grade by account date}
library(lubridate)

data %>%
  group_by(CreditGrade) %>%
  summarize_if(is.Date, min, na.rm=TRUE)

data %>%
  group_by(CreditGrade) %>%
  summarize_if(is.Date , max, na.rm=TRUE)

library(skimr)

skim(filter(data,is.na(CreditGrade)))

skim(filter(data,!is.na(CreditGrade)))

```

This may be more useeful - NAs had listing created and closed later, although there was some amount of overlap, so it's not clear if there's an obvious separating factor.  The major difference seems to be that 

### How Correlated are Profit Factors?

Here, I quickly want to look at how well-correlated the numerical factors associated with profit are, to see if I need to look at all of them when seeing how predictive demographic factors are of profit.

```{r profit correlation plot}
profit <- c("LenderYield", "EstimatedEffectiveYield", "EstimatedLoss", "EstimatedReturn", "CurrentDelinquencies", "AmountDelinquent", "OnTimeProsperPayments", "LoanCurrentDaysDelinquent", "LP_GrossPrincipalLoss", "LP_NetPrincipalLoss","ProsperRating.num")

library(ggcorrplot)

corr <- cor(data[profit], use = "complete.obs")
head(corr[, 1:6])

ggcorrplot(corr, hc.order = TRUE, type = "lower",
     outline.col = "white", lab = TRUE)
```

It turns out that most of the potential profit measures are not that well-correlated.  Several, however, are well-correlated with each other (poisitively or negatively), and I expect these to likely be better representations of profit (as, if a potential measure of profit correlates with no other potential measures of profit, then it it unlikely to represent profit well, unless it is the single accurate measure of profit in the bunch, which is unlikely).

The profit measures showing the highest correlations with other measures are the following: `EstimatedReturn`, `EstimatedEffectiveYield`, `EstimatedLoss`, `LenderYield`, and `ProsperRating`.  It's likely that the other measures are informative for other, more specific, questions, but at a first glance, it makes sense to look at the most obvious measures of profit.  It's also possible that `LoanStatus`, previously looked at, is also informative, but it has a more indirect relationship to profit (especially given that, as a category, it is inherently in flux).

### Occupation vs. Profit

If credit grades are only assigned once the fate of the loan is known, it may be more useful to look at how predictive pre-existing factors such as `Occupation` are of profit measures.

```{r profit by occupation}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","Occupation")

plot_data <- data[subset] %>% 
  group_by(Occupation) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  mutate(Occupation = reorder(Occupation, ProsperRating.num, mean)) %>%
  gather(Measure, Value, -Occupation)

ggplot(plot_data, aes(x = Occupation, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by Occupation") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

There are too many occupations to make easy generalizations.  Occupations would likely need to be grouped into a smaller number of categories.  However, one can observe general trends - those with higher-paying occupations (or occupational prospects) seem to be more profitable customers.  On the other hand, students in general are among the bank's least profitable customers.  This suggests that income, which is grouped in a more sensible manner, may be useful to look at.

### Income Range vs. Profit

```{r profit by income range}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","IncomeRange")

plot_data <- data[subset] %>% 
  group_by(IncomeRange) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -IncomeRange)

ggplot(plot_data, aes(x = IncomeRange, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by IncomeRange") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Here, it can be seen that as income rises, the `ProsperRating` increases, and other measures of profit decrease.  **As we have seen, `ProsperRating` correlates with credit score and likelihood of not defaulting**. This suggests that high-income lenders are lower-risk, but lower-income lenders, while being higher-risk, can also yield more profit.

### Other vs. Profit

Here, I will look at the relationship between other predictors and profit measures.

`EmploymentStatus`

```{r profit by employment status}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","EmploymentStatus")

plot_data <- data[subset] %>% 
  group_by(EmploymentStatus) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -EmploymentStatus)

ggplot(plot_data, aes(x = EmploymentStatus, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by EmploymentStatus") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`EmploymentStatusDuration`

```{r profit by employment status duration}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","EmploymentStatusDuration")

plot_data <- data[subset] %>% 
  group_by(EmploymentStatusDuration) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -EmploymentStatusDuration)

ggplot(plot_data, aes(x = EmploymentStatusDuration, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by EmploymentStatusDuration") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`IsBorrowerHomeowner`

```{r profit by homeowner}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","IsBorrowerHomeowner")

plot_data <- data[subset] %>% 
  group_by(IsBorrowerHomeowner) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -IsBorrowerHomeowner)

ggplot(plot_data, aes(x = IsBorrowerHomeowner, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by IsBorrowerHomeowner") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`FirstRecordedCreditLine`

```{r profit by first credit line}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","FirstRecordedCreditLine")

plot_data <- data[subset] %>% 
  group_by(FirstRecordedCreditLine) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -FirstRecordedCreditLine)

ggplot(plot_data, aes(x = FirstRecordedCreditLine, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by FirstRecordedCreditLine") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`OpenRevolvingAccounts`

```{r profit by open revolving accounts}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","OpenRevolvingAccounts")

plot_data <- data[subset] %>% 
  group_by(OpenRevolvingAccounts) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -OpenRevolvingAccounts)

ggplot(plot_data, aes(x = OpenRevolvingAccounts, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by OpenRevolvingAccounts") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`InquiriesLast6Months`

```{r profit by credit inquiries}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","InquiriesLast6Months")

plot_data <- data[subset] %>% 
  group_by(InquiriesLast6Months) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -InquiriesLast6Months)

ggplot(plot_data, aes(x = InquiriesLast6Months, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by InquiriesLast6Months") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`RevolvingCreditBalance`

```{r profit by revolving credit balance}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","RevolvingCreditBalance")

plot_data <- data[subset] %>% 
  group_by(RevolvingCreditBalance) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -RevolvingCreditBalance)

ggplot(plot_data, aes(x = RevolvingCreditBalance, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by RevolvingCreditBalance") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`BankcardUtilization`

```{r profit by bank card use}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","BankcardUtilization")

plot_data <- data[subset] %>% 
  group_by(BankcardUtilization) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -BankcardUtilization)

ggplot(plot_data, aes(x = BankcardUtilization, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by BankcardUtilization") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`TotalTrades`

```{r profit by total trades}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","TotalTrades")

plot_data <- data[subset] %>% 
  group_by(TotalTrades) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -TotalTrades)

ggplot(plot_data, aes(x = TotalTrades, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by TotalTrades") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`DebtToIncomeRatio`

```{r profit by debt to income ratio}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","DebtToIncomeRatio")

plot_data <- data[subset] %>% 
  group_by(DebtToIncomeRatio) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -DebtToIncomeRatio)

ggplot(plot_data, aes(x = DebtToIncomeRatio, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by DebtToIncomeRatio") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`IncomeVerifiable`

```{r profit by whether income verifiable}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","IncomeVerifiable")

plot_data <- data[subset] %>% 
  group_by(IncomeVerifiable) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -IncomeVerifiable)

ggplot(plot_data, aes(x = IncomeVerifiable, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by IncomeVerifiable") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`TotalProsperLoans`

```{r profit by total prosper loans}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","TotalProsperLoans")

plot_data <- data[subset] %>% 
  group_by(TotalProsperLoans) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -TotalProsperLoans)

ggplot(plot_data, aes(x = TotalProsperLoans, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by TotalProsperLoans") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

`LoanOriginationQuarter`

```{r profit by loan orig. quarter}
subset <- c("EstimatedReturn", "EstimatedEffectiveYield", "EstimatedLoss", "LenderYield", "ProsperRating.num","LoanOriginationQuarter")

plot_data <- data[subset] %>% 
  group_by(LoanOriginationQuarter) %>% 
  summarize_all(funs(mean(., na.rm = TRUE))) %>%
  gather(Measure, Value, -LoanOriginationQuarter)

ggplot(plot_data, aes(x = LoanOriginationQuarter, y=Value)) +
  geom_bar(stat = "identity") +
  labs(title = "Profit by LoanOriginationQuarter") +
  facet_grid(~Measure, scales="free") +
  coord_flip() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Ultimately, without knowing how the loans ultimately panned out, it is a bit difficult to use this data to make future predictions.

## Final Plots and Summary

You will select three plots from your analysis to polish and share in this section. The three plots should show different trends and should be polished with appropriate labels, units, and titles (see the Project Rubric for more information).

```{r final plot 1, echo=FALSE}

```

```{r final plot 2, echo=FALSE}

```

```{r final plot 3, echo=FALSE}

```

## Reflection

This should contain a few sentences about your struggles, successes, and ideas for future exploration on the data set (see the Project Rubric for more information).
